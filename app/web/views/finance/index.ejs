<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <%= title %>
    </h1>
</div>
<div class="row">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Income</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <%= formatCurrency(income[0].amount) %>
                        </div>
                    </div>
                    <!--div class="col-auto">
                        <i class="fas fa-calendar fa-2x text-gray-300"></i>
                    </div-->
                </div>
            </div>
        </div>
    </div>

    <!-- Earnings (Monthly) Card Example -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Spending</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <%= formatCurrency(outgoings[0].amount) %>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Earnings (Monthly) Card Example -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tasks
                        </div>
                        <div class="row no-gutters align-items-center">
                            <div class="col-auto">
                                <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">50%</div>
                            </div>
                            <div class="col">
                                <div class="progress progress-sm mr-2">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 50%"
                                        aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Requests Card Example -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Sth</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            sth
                        </div>
                    </div>
                    <!--div class="col-auto">
                        <i class="fas fa-comments fa-2x text-gray-300"></i>
                    </div-->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Overview</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-5">
                <form role="form">
                    <select name="month" onchange="this.form.submit();" class="form-select mb-3">
                        <% for (let year=2023; year>= 2022; year--) { %>
                            <% for (let month=12; month>= 1; month--) { %>
                                <option value="<%= year %>-<%= month.toString().padStart(2, '0') %>" <% if
                                    (yearmonth==`${year}-${month.toString().padStart(2, '0' )}`) { %>selected<% } %>>
                                        <%= new Date(year, month - 1, 1).toLocaleString('default', { month: 'long' ,
                                            year: 'numeric' }) %>
                                </option>
                                <% } %>
                                    <% } %>
                    </select>
                </form>
            </div>
        </div>
        <div id="monthlySpendingChart"></div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Incoming</th>
                        <th>Outgoing</th>
                    </tr>
                </thead>
                <tbody>
                    <% for (let i=0; i < income.length; i++) { %>
                        <tr>
                            <td>
                                <%= income[i].month %>
                            </td>
                            <td align="right">
                                <%= formatCurrency(income[i].amount) %>
                            </td>
                            <td align="right">
                                <%= formatCurrency(outgoings[i].amount) %>
                            </td>
                        </tr>
                        <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>


<!--div class="row">
    <div class="col-md-6">
        <div>
            <a href="/trends">Trends</a>
        </div>
        <div>
            <a href="?month=2023-01">January</a> |
            <a href="?month=2023-02">February</a> |
            <a href="?month=2023-03">March</a> |
            <a href="?month=2023-04">April</a> |
            <a href="?month=2023-05">May</a> |
            <a href="?month=2023-06">June</a> |
            <a href="?month=2023-07">July</a> |
        </div>
        <div>
            Total spent excluding one-off costs: &pound;
        </div>

    </div>
    <div class="col-md-6">
        <div>
            <canvas id="spendingByCategoryChart"></canvas>
        </div>
    </div>
</div-->
<script>
    const income = <%- JSON.stringify(income) %>;
    const spending = <%- JSON.stringify(outgoings) %>;

    const categories = ['income', 'spending'];
    const colors = ['blue', 'red'];

    const allData = { income, spending };

    const monthsSet = new Set(income.map(r => r.month).concat(spending.map(r => r.month)));
    const months = Array.from(monthsSet).sort((a, b) => new Date(a) - new Date(b));

    const makeSeriesData = (categoryData) => {
        const dataMap = new Map();
        categoryData.forEach(r => {
            const [year, month] = r.month.split('-').map(Number);
            const timestamp = Date.UTC(year, month - 1, 1);

            dataMap.set(timestamp, r.amount);
        });

        const seriesData = [];
        months.forEach(m => {
            const [year, month] = m.split('-').map(Number);
            const timestamp = Date.UTC(year, month - 1, 1);

            seriesData.push([
                timestamp,
                dataMap.get(timestamp) || null
            ]);
        });

        return seriesData;
    };

    const seriesData = categories.map((category, index) => ({
        name: category,
        data: makeSeriesData(allData[category]),
        color: colors[index],
        connectNulls: false,
        marker: { enabled: true }
    }));

    Highcharts.chart('monthlySpendingChart', {
        chart: {
            type: 'line'
        },
        title: {
            text: ''
        },
        xAxis: {
            // categories: months,
            type: 'datetime',
            title: {
                text: 'Date'
            },
            labels: {
                formatter: function () {
                    return Highcharts.dateFormat('%b %Y', this.value);
                }
            }
        },
        yAxis: {
            title: {
                text: 'Amount'
            },
            stackLabels: {
                enabled: true,
                formatter: function () {
                    return '£' + Highcharts.numberFormat(this.total, 0, ',', ',');
                },
            },
            labels: {
                formatter: function () {
                    return '£' + Highcharts.numberFormat(this.value, 0, ',', ',');
                }
            },
        },
        series: seriesData,
        tooltip: {
            borderColor: '#dddfeb',
            backgroundColor: 'rgb(255,255,255)',
            style: {
                color: '#858796'
            },
            formatter: function () {
                return `<b>${this.series.name}</b><br>${Highcharts.dateFormat('%b %Y', this.x)}: £${Highcharts.numberFormat(this.y, 2, '.', ',')}`;
            },
            borderWidth: 1
        },
        responsive: {
            rules: [{
                condition: {
                    maxWidth: 500
                },
                chartOptions: {
                    legend: {
                        layout: 'horizontal',
                        align: 'center',
                        verticalAlign: 'bottom'
                    }
                }
            }]
        }
    });

</script>
<script src="/vendor/datatables/jquery.dataTables.min.js"></script>
<script src="/vendor/datatables/dataTables.bootstrap4.min.js"></script>